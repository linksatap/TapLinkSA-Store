// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. USERS - جدول المستخدمين (مالكي الأعمال)
// ============================================
model User {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  email                 String     @unique
  password              String     // يجب تشفيرها باستخدام bcrypt
  name                  String
  phone                 String?
  avatar                String?    // رابط الصورة
  
  // الدور والصلاحيات
  role                  String     @default("user") // "user", "admin", "business"
  isActive              Boolean    @default(true)
  
  // بيانات المصادقة
  emailVerified         DateTime?
  lastLogin             DateTime?
  
  // العلاقات
  businesses            Business[]
  
  // الطوابع الزمنية
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  
  @@index([email])
  @@index([role])
}

// ============================================
// 2. BUSINESSES - جدول الأعمال/العملاء
// ============================================
model Business {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  
  // معلومات الأساسية
  name                  String     // اسم العميل/الشركة
  slug                  String     @unique // للرابط المخصص /r/[slug]
  description           String?
  logo                  String?    // رابط الشعار
  website               String?
  
  // معلومات الاتصال
  email                 String?
  phone                 String?
  
  // بيانات المالك
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // الإعدادات الخاصة بالتقييم
  whatsappNumber        String?    // رقم واتساب للتقييمات 1-3 نجوم
  googlePlaceId         String?    // Google Place ID للتقييمات 4-5 نجوم
  googleReviewLink      String?    // رابط Google Review مباشر
  
  // الإحصائيات
  totalViews            Int        @default(0)
  totalFeedback         Int        @default(0)
  averageRating         Float      @default(0)
  
  // حالة العمل
  isActive              Boolean    @default(true)
  isPremium             Boolean    @default(false)
  
  // العلاقات
  feedbacks             Feedback[]
  views                 View[]
  settings              BusinessSettings?
  
  // الطوابع الزمنية
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  
  @@index([userId])
  @@index([slug])
  @@index([isActive])
}

// ============================================
// 3. BUSINESS SETTINGS - إعدادات العمل
// ============================================
model BusinessSettings {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  
  businessId            String     @unique @db.ObjectId
  business              Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // الألوان والتصميم
  primaryColor          String     @default("#FBBF24")
  secondaryColor        String     @default("#111827")
  
  // الرسائل المخصصة
  welcomeMessage        String?    // رسالة الترحيب
  lowRatingMessage      String?    // رسالة التقييم المنخفض (1-3)
  highRatingMessage     String?    // رسالة التقييم العالي (4-5)
  
  // الإعدادات المتقدمة
  enableNotifications   Boolean    @default(true)
  notificationEmail     String?
  redirectAfterReview   Boolean    @default(true)
  
  // الطوابع الزمنية
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  
  @@index([businessId])
}

// ============================================
// 4. FEEDBACK - جدول التقييمات
// ============================================
model Feedback {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  
  // التقييم الأساسي
  rating                Int        // 1-5 نجوم
  comment               String?    // تعليق اختياري
  
  // معلومات المقيّم
  visitorName           String?    // اسم الزائر (اختياري)
  visitorEmail          String?    // بريد الزائر (اختياري)
  visitorPhone          String?    // هاتف الزائر (اختياري)
  
  // المصدر
  businessId            String     @db.ObjectId
  business              Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // الحالة
  status                String     @default("pending") // "pending", "approved", "rejected", "sent_to_whatsapp", "sent_to_google"
  
  // معلومات إضافية
  userAgent             String?    // معلومات المتصفح
  ipAddress             String?    // عنوان IP
  
  // الطوابع الزمنية
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  
  @@index([businessId])
  @@index([rating])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// 5. VIEWS - جدول الزيارات
// ============================================
model View {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  
  // معلومات الزيارة
  businessId            String     @db.ObjectId
  business              Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // معلومات الزائر
  userAgent             String?    // معلومات المتصفح
  ipAddress             String?    // عنوان IP
  referer               String?    // مصدر الزيارة
  
  // معلومات الجهاز
  deviceType            String?    // "mobile", "tablet", "desktop"
  country               String?    // الدولة (من IP)
  city                  String?    // المدينة (من IP)
  
  // الطابع الزمني
  createdAt             DateTime   @default(now())
  
  @@index([businessId])
  @@index([createdAt])
  @@index([deviceType])
}

// ============================================
// 6. ANALYTICS - جدول التحليلات اليومية
// ============================================
model DailyAnalytics {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  
  businessId            String     @db.ObjectId
  business              Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // التاريخ
  date                  DateTime   @db.Date
  
  // الإحصائيات
  viewsCount            Int        @default(0)
  feedbackCount         Int        @default(0)
  averageRating         Float      @default(0)
  
  // توزيع التقييمات
  rating1Count          Int        @default(0)
  rating2Count          Int        @default(0)
  rating3Count          Int        @default(0)
  rating4Count          Int        @default(0)
  rating5Count          Int        @default(0)
  
  // التوزيع حسب الجهاز
  mobileViews           Int        @default(0)
  tabletViews           Int        @default(0)
  desktopViews          Int        @default(0)
  
  // الطوابع الزمنية
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  
  @@unique([businessId, date])
  @@index([businessId])
  @@index([date])
}

// ============================================
// 7. AUDIT LOG - سجل التدقيق
// ============================================
model AuditLog {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  
  // المستخدم الذي قام بالعملية
  userId                String?    @db.ObjectId
  
  // نوع العملية
  action                String     // "create", "update", "delete", "view", "feedback"
  resource              String     // "business", "feedback", "settings"
  resourceId            String?
  
  // التفاصيل
  changes               Json?      // تسجيل التغييرات
  
  // الطابع الزمني
  createdAt             DateTime   @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
